<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="/static/img/favicon.png">
  <title>TaskBoard — Settings</title>

  <!-- Fonts & icons -->
  <link href="/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">

  <!-- SB Admin & Bootstrap 5 -->
  <link href="/static/css/sb-admin-2.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

  <!-- App styles -->
  <link rel="stylesheet" href="/static/css/style.css">

  <style>
    /* Contenedor externo: referencia para el botón flotante */
.avatar-stack{
  position: relative;
  width: 140px;
  height: 140px;
}

/* El círculo que recorta la foto */
.avatar-wrapper{
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;              /* recorta solo la imagen */
  background: #f8f9fc;
  box-shadow: 0 0 0 1px rgba(0,0,0,.05) inset;
}
.avatar-wrapper img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* Botón flotante superpuesto (fuera del círculo) */
.avatar-add-fab{
  position: absolute;
  right: -6px;                   /* ligeramente fuera del borde */
  bottom: -6px;
  z-index: 2;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: #fff;
  border: 2px dashed #198754;
  color: #198754;
  display: grid;
  place-items: center;
  box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.avatar-add-fab:hover{ filter: brightness(0.98); }
  </style>
</head>

<body id="page-top">
  <div id="wrapper">
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <ul class="navbar-nav ms-auto">
            <div class="topbar-divider d-none d-sm-block"></div>
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                 data-bs-toggle="dropdown" aria-expanded="false">
                <span class="me-2 d-none d-lg-inline text-gray-600 small">{{ username }}</span>
                <img class="img-profile rounded-circle"
                     src="/static/img/profile_images/{{ id }}/user.png"
                     onerror="this.onerror=null; this.src='/static/img/profile_images/0/user.png';">
              </a>
              <div class="dropdown-menu dropdown-menu-end shadow animated--grow-in"
                   aria-labelledby="userDropdown">
                <a class="dropdown-item" href="/">
                  <i class="fas fa-columns fa-sm fa-fw me-2 text-gray-400"></i>
                  Back to Board
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#logoutModal">
                  <i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>
                  Logout
                </a>
              </div>
            </li>
          </ul>
        </nav>

        <!-- Page Content -->
        <div class="container-fluid">

          <!-- SOLO botón Back to Board arriba a la derecha -->
          <div class="d-flex justify-content-end mb-3">
            <a href="/" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-arrow-left me-1"></i> Back to Board
            </a>
          </div>

          <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
              <div class="card border-0 shadow-sm mb-5">
                <div class="card-body p-4 p-md-5">

                  <!-- Profile Image -->
                  <h6 class="section-title mb-3">Profile image</h6>
<div class="text-center mb-3">
  <!-- Contenedor externo que NO recorta -->
  <div class="avatar-stack mx-auto" id="avatarArea">
    <!-- Círculo que sí recorta la foto -->
    <div class="avatar-wrapper">
      <img id="avatarPreview"
           src="/static/img/profile_images/{{ id }}/user.png"
           alt="Profile"
           onerror="this.onerror=null; this.src='/static/img/profile_images/0/user.png';">
    </div>

    <!-- Botón flotante superpuesto (fuera del wrapper) -->
    <button id="btnPickAvatar" type="button" class="avatar-add-fab" aria-label="Choose image">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <input id="avatarInput" type="file" accept="image/png" class="d-none">
  <button class="btn btn-primary btn-sm mt-2" id="btnSaveAvatar" type="button">
    Update
  </button>
</div>

                  <hr class="my-4">

                  <!-- Basic info form -->
                  <h6 class="section-title mb-3">User info</h6>
                  <form id="profileInfoForm" class="needs-validation" novalidate>
                    <div class="mb-3">
                      <label class="form-label" for="userName">
                        <i class="far fa-user me-1"></i>User Name
                      </label>
                      <input id="userName" name="username" class="form-control" required maxlength="80"
                             placeholder="Your display name" value="{{ username }}">
                      <div class="invalid-feedback">User name is required.</div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label" for="userEmail">
                        <i class="far fa-envelope me-1"></i>Email
                      </label>
                      <input id="userEmail" name="email" type="email" class="form-control" required
                             placeholder="you@example.com" value="{{ email }}">
                      <div class="invalid-feedback">Please provide a valid email.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Update</button>
                  </form>

                  <hr class="my-4">

                  <!-- Password form -->
                  <h6 class="section-title mb-3">Password</h6>
                  <form id="passwordForm" class="needs-validation" novalidate>
                    <div class="mb-3">
                      <label class="form-label" for="currentPassword">
                        <i class="fas fa-lock me-1"></i>Current password
                      </label>
                      <div class="input-group">
                        <input id="currentPassword" name="current_password" type="password" class="form-control" required>
                        <button class="btn btn-outline-secondary" type="button" data-toggle-password="currentPassword">
                          <i class="far fa-eye"></i>
                        </button>
                        <div class="invalid-feedback">Required.</div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label" for="newPassword">New password</label>
                      <div class="input-group">
                        <input id="newPassword" name="new_password" type="password" class="form-control" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" data-toggle-password="newPassword">
                          <i class="far fa-eye"></i>
                        </button>
                        <div class="invalid-feedback">Min 6 characters.</div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label" for="confirmPassword">Confirm new password</label>
                      <div class="input-group">
                        <input id="confirmPassword" name="confirm_password" type="password" class="form-control" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" data-toggle-password="confirmPassword">
                          <i class="far fa-eye"></i>
                        </button>
                        <div class="invalid-feedback">Please confirm the new password.</div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Update</button>
                  </form>

                  <!-- Delete account (dentro del card, abajo a la derecha) -->
                  <div class="d-flex justify-content-end mt-4">
                    <a href="#" class="text-danger text-decoration-none" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                      <i class="fas fa-trash-alt me-1"></i> Delete Account
                    </a>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div><!-- /.container-fluid -->
      </div><!-- End Main Content -->

      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; TaskBoard 2025</span>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Scroll to Top -->
  <a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ready to Leave?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <a class="btn btn-primary" onclick="logout()">Logout</a>
      </div>
    </div></div>
  </div>

  <!-- Delete Account Modal -->
  <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" onsubmit="event.preventDefault(); deleteAccountConfirmed();">
        <div class="modal-header">
          <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Delete account?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          This action cannot be undone. All your tasks and data will be permanently removed.
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteAccountBtn" class="btn btn-danger" type="submit">Delete Account</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
    <div id="globalToast" class="toast align-items-center text-white bg-success border-0"
         role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Done.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
  <script src="/static/vendor/jquery/jquery.min.js"></script>
  <script src="/static/vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="/static/js/sb-admin-2.min.js"></script>

  <script>
(() => {
  /* ================== Config ================== */
  const BASE_URL = window.location.origin || window.location.protocol + '//' + window.location.host;


  const API = {
    uploadImage: BASE_URL + '/api/v1/user_settings/profile_image',
    userDetails: BASE_URL + '/api/v1/user_settings/user_details',
    password:    BASE_URL + '/api/v1/user_settings/password',
    deleteAcct:  BASE_URL + '/api/v1/user_settings/',
    logout:      BASE_URL + '/api/v1/logout'
  };
  const MAX_AVATAR_SIZE = 5 * 1024 * 1024; // 5 MB

  /* ================== Helpers ================== */
  const $ = (id) => document.getElementById(id);

  function showToast(message, variant = 'success', delay = 1500) {
    const toastEl = $('globalToast');
    if (!toastEl) { alert(message); return; }
    toastEl.classList.remove('bg-success','bg-danger','bg-warning','bg-info','bg-primary','bg-secondary','bg-dark');
    toastEl.classList.add(`bg-${variant}`);
    toastEl.querySelector('.toast-body').textContent = message;
    bootstrap.Toast.getOrCreateInstance(toastEl, { delay }).show();

    // refresh page after showing the toast
    if (variant === 'success') {
      setTimeout(() => { location.reload(); }, delay + 500);
    }
  }

  async function handleJson(resp) {
    let json = null;
    try { json = await resp.json(); } catch (_) {}
    if (!resp.ok) {
      const msg = json?.message || `HTTP ${resp.status}`;
      const err = new Error(msg);
      err.status = resp.status;
      throw err;
    }
    return json;
  }

  function setBusy(btn, busy, textWhenBusy = 'Working...') {
    if (!btn) return;
    if (busy) {
      btn.dataset.__html = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = textWhenBusy;
    } else {
      btn.disabled = false;
      if (btn.dataset.__html != null) btn.innerHTML = btn.dataset.__html;
    }
  }

  function togglePasswordVisibility(inputId) {
    const input = $(inputId);
    if (!input) return;
    input.type = input.type === 'password' ? 'text' : 'password';
  }

  function isUnauthorized(err) {
    return (err?.status === 401) || /401/.test(String(err?.message || ''));
  }

  // === Validación de archivo de avatar según el backend ===
  function validateAvatarFile(file) {
    if (!file) return { ok: false, msg: 'Select an image first.' };

    // 1) Debe ser image/*
    if (!file.type || !file.type.startsWith('image/')) {
      return { ok: false, msg: 'Invalid file type. Only image files are allowed.' };
    }

    // 2) Únicamente PNG (MIME y extensión)
    const isPNGByMime = file.type === 'image/png';
    const isPNGByExt  = /\.png$/i.test(file.name || '');
    if (!(isPNGByMime && isPNGByExt)) {
      return { ok: false, msg: 'Invalid file type. Only PNG is allowed.' };
    }

    // 3) Límite de 5 MB
    if (file.size > MAX_AVATAR_SIZE) {
      return { ok: false, msg: 'File size exceeds the limit of 5 MB.' };
    }

    return { ok: true };
  }

  /* ============== API Actions (real) ============== */

  // 1) Subir imagen de perfil (con validaciones frontend)
  async function updateProfileImage(file, btn) {
    try {
      const check = validateAvatarFile(file);
      if (!check.ok) { showToast(check.msg, 'danger', 2200); return; }

      const fd = new FormData();
      fd.append('file', file);

      setBusy(btn, true, 'Uploading...');
      const resp = await fetch(API.uploadImage, {
        method: 'POST',
        credentials: 'include',
        body: fd
      });
      await handleJson(resp);

      // Cache-busting del preview
      const img = $('avatarPreview');
      if (img) {
        const base = img.src.split('?')[0];
        img.src = `${base}?t=${Date.now()}`;
      }

      showToast('Profile image uploaded successfully.', 'success', 1400);
    } catch (err) {
      console.error(err);
      if (isUnauthorized(err)) {
        showToast('User not authenticated. Please log in again.', 'danger', 2500);
      } else {
        // 40X/50X
        showToast('Error uploading image. Please try again later.', 'danger', 2200);
      }
    } finally {
      setBusy(btn, false);
    }
  }

  // 2) Actualizar username + email
  async function updateProfileInfo(form, btn) {
    try {
      const payload = {
        username: form.username.value.trim(),
        email: form.email.value.trim()
      };
      setBusy(btn, true, 'Saving...');
      const resp = await fetch(API.userDetails, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      await handleJson(resp);
      showToast('Profile saved.', 'success', 1400);
    } catch (err) {
      console.error(err);
      if (isUnauthorized(err)) {
        showToast('User not authenticated. Please log in again.', 'danger', 2500);
      } else {
        showToast('Error saving profile. Please try again later.', 'danger', 2200);
      }
    } finally {
      setBusy(btn, false);
    }
  }

  // 3) Actualizar contraseña (endpoint espera { username: old_password, email: new_password })
  async function updatePassword(form, btn) {
    try {
      const payload = {
        old_password: form.current_password.value || '',
        new_password:    form.new_password.value || ''
      };
      setBusy(btn, true, 'Updating...');
      const resp = await fetch(API.password, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      await handleJson(resp);
      form.reset();
      showToast('Password updated.', 'success', 1400);
    } catch (err) {
      console.error(err);
      if (isUnauthorized(err)) {
        showToast('User not authenticated. Please log in again.', 'danger', 2500);
      } else {
        showToast('Error updating password. Please try again later.', 'danger', 2200);
      }
    } finally {
      setBusy(btn, false);
    }
  }

  // 4) Eliminar cuenta
  async function deleteAccountConfirmed() {
    const modalEl = $('deleteAccountModal');
    const btn = $('confirmDeleteAccountBtn');
    try {
      setBusy(btn, true, 'Deleting...');
      const resp = await fetch(API.deleteAcct, {
        method: 'DELETE',
        credentials: 'include'
      });
      await handleJson(resp);
      bootstrap.Modal.getOrCreateInstance(modalEl).hide();
      showToast('Account deleted.', 'success', 1400);
      setTimeout(() => { location.href = '/'; }, 1000);
    } catch (err) {
      console.error(err);
      bootstrap.Modal.getOrCreateInstance(modalEl).hide();
      if (isUnauthorized(err)) {
        showToast('User not authenticated. Please log in again.', 'danger', 2500);
      } else {
        showToast('Error deleting account. Please try again later.', 'danger', 2200);
      }
    } finally {
      setBusy(btn, false);
    }
  }

  // Logout (igual que antes)
  async function logout() {
    try {
      const response = await fetch(API.logout, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.success) { alert('Logout successful!'); location.href = '/'; }
      else { alert('Logout failed: ' + data.message); }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred while logging out.');
    }
  }

  /* ============= Wire-up de eventos UI ============= */
  document.addEventListener('DOMContentLoaded', () => {
    // Avatar
    const avatarInput   = $('avatarInput');
    const avatarPreview = $('avatarPreview');
    const btnPickAvatar = $('btnPickAvatar');
    const btnSaveAvatar = $('btnSaveAvatar');

    // Recomendación HTML (si puedes): <input accept="image/png">
    // De todos modos, validamos aquí también.
    let lastURL = null;

    btnPickAvatar?.addEventListener('click', () => avatarInput?.click());

    avatarInput?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      // Validación antes del preview
      const check = validateAvatarFile(file);
      if (!check.ok) {
        showToast(check.msg, 'danger', 2200);
        // reset del input
        e.target.value = '';
        return;
      }

      // Preview seguro
      if (lastURL) URL.revokeObjectURL(lastURL);
      lastURL = URL.createObjectURL(file);
      avatarPreview.onload = () => { if (lastURL) { URL.revokeObjectURL(lastURL); lastURL = null; } };
      avatarPreview.src = lastURL;
    });

    btnSaveAvatar?.addEventListener('click', () => {
      const file = avatarInput?.files?.[0];
      updateProfileImage(file, btnSaveAvatar);
    });

    // User info
    const infoForm = $('profileInfoForm');
    infoForm?.addEventListener('submit', (ev) => {
      ev.preventDefault();
      if (!infoForm.checkValidity()) { infoForm.classList.add('was-validated'); return; }
      const submitBtn = infoForm.querySelector('button[type="submit"]');
      updateProfileInfo(infoForm, submitBtn);
    });

    // Password
    const pwdForm = $('passwordForm');
    pwdForm?.addEventListener('submit', (ev) => {
      ev.preventDefault();
      if (!pwdForm.checkValidity()) { pwdForm.classList.add('was-validated'); return; }
      const np = pwdForm.new_password.value;
      const cp = pwdForm.confirm_password.value;
      if (np !== cp) { showToast('Passwords do not match.', 'danger', 2000); return; }
      const submitBtn = pwdForm.querySelector('button[type="submit"]');
      updatePassword(pwdForm, submitBtn);
    });

    // Ojos de password
    document.querySelectorAll('[data-toggle-password]').forEach(btn => {
      btn.addEventListener('click', () => togglePasswordVisibility(btn.dataset.togglePassword));
    });
  });

  /* Exponer funciones usadas por atributos HTML */
  window.deleteAccountConfirmed = deleteAccountConfirmed;
  window.logout = logout;
  window.togglePasswordVisibility = togglePasswordVisibility;
})();
</script>
</body>
</html>